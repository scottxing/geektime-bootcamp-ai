# PostgreSQL MCP Server 技术设计文档 - 架构评审报告

## 评审信息

| 项目       | 内容                                       |
|------------|-------------------------------------------|
| 评审文档   | 0002-pg-mcp-design.md                     |
| 评审日期   | 2025-12-20                                |
| 评审工具   | OpenAI Codex CLI (gpt-5.1-codex-max)      |
| 评审角度   | 高级技术架构师视角                        |
| 整体评分   | 6.5/10                                    |

---

## 核心优势

- 清晰的分层架构设计，组件边界定义明确
- 合理的技术栈选型 (FastMCP、asyncpg、SQLGlot、Pydantic)
- 良好的设计意图：安全优先、异步优先、单一职责
- 详细的代码示例和完整的项目结构

---

## 评审发现

### Critical (关键) - 必须修复

#### 1. 缺失认证和授权机制

- **位置**: MCP 工具层
- **问题**:
  - 没有任何认证/授权逻辑
  - 任何 MCP 客户端都可以访问所有配置的数据库
  - 没有租户隔离、用户级别的权限控制
  - 缺少审计日志记录请求来源
- **影响**: 完全暴露数据库访问权限
- **建议**: 实现基于角色的访问控制 (RBAC)，添加认证中间件

#### 2. 查询结果未限制导致 DoS 风险

- **位置**: `sql_executor.py` 第 1246-1280 行
- **问题**: 先 fetch 所有行再切片，可能返回百万行导致内存耗尽
- **影响**: 内存耗尽、网络带宽耗尽、数据库负载过高
- **建议**:
  - 在 SQL 验证阶段强制添加 LIMIT
  - 使用游标流式获取
  - 设置数据库级别的 statement_timeout

#### 3. 敏感数据泄露到外部 LLM

- **位置**: `result_validator.py`
- **问题**: 直接发送查询结果到 OpenAI，可能包含 PII、敏感业务数据
- **影响**: 违反数据保护法规 (GDPR、CCPA)
- **建议**:
  - 默认禁用结果验证功能
  - 实现敏感列脱敏
  - 提供本地验证选项

---

### High (高优先级)

#### 4. 限流和熔断器未实际应用

- **问题**: `ResilienceConfig` 定义了限流参数但未使用
- **影响**: 并发请求无限制，可能压垮数据库或 LLM API
- **建议**: 在 `query()` 工具中集成 `RateLimiter`

#### 5. Schema 缓存刷新未实现

- **问题**: `auto_refresh` 和 `refresh_interval_minutes` 定义但未使用
- **影响**: Schema 漂移导致 SQL 生成错误
- **建议**: 实现后台定时刷新任务

---

### Medium (中优先级)

#### 6. 可观测性未完全接入

- **问题**: 指标定义但未在关键路径调用，没有暴露 `/metrics` 端点
- **建议**: 在关键路径插入指标收集，初始化 OpenTelemetry

#### 7. SQL 验证的边缘情况

- **问题**:
  - 没有阻止访问系统 schema (`pg_catalog`, `information_schema`)
  - `SET ROLE` 的 role 名称未加引号，存在注入风险
- **建议**:
  - 自动阻止系统 schema
  - 使用参数化或引用标识符
  - 补充 pglast 作为 PostgreSQL 原生解析器

#### 8. 熔断器并发安全问题

- **位置**: `circuit_breaker.py`
- **问题**: 定义了 `_lock` 但从未使用，`allow_request()` 没有加锁
- **建议**: 将 `allow_request` 改为 async 并使用锁

---

### Low / Info (信息类)

#### 9. 技术选型分析

| 组件 | 技术选择 | 评价 |
|------|---------|------|
| MCP 框架 | FastMCP 2.0+ | ✅ 合理 |
| PostgreSQL 驱动 | asyncpg 0.29+ | ✅ 优秀 |
| SQL 解析 | SQLGlot 26.0+ | ⚠️ 部分合理，建议补充 pglast |
| 数据模型 | Pydantic 2.0+ | ✅ 最佳实践 |
| LLM 集成 | openai 1.50+ | ✅ 合理 |

#### 10. 遗漏的设计点

| 类别 | 遗漏内容 |
|------|---------|
| 部署 | Dockerfile、K8s 部署清单、健康检查端点 |
| 测试 | Mock 策略、性能测试基准 |
| 安全 | 密钥管理（Secrets Manager）、SSL/TLS 配置 |
| 灾备 | 数据库故障转移、LLM 降级策略 |
| 多租户 | 租户隔离、配额管理 |

---

## 优先级建议

### 必须实施 (Phase 1)

1. **实现 MCP 层认证和审计** - 2-3 天
2. **强制查询限制和流式获取** - 1-2 天
3. **应用限流和熔断器** - 1 天
4. **数据隐私控制** - 2 天
5. **完善可观测性** - 2 天

### 可选改进 (Phase 2)

- Schema 缓存自动刷新
- SQL 验证增强（pglast 补充）
- 熔断器并发安全修复
- 部署文档和健康检查

---

## 改进后架构建议

```
MCP Client (with Auth Token)
    │
    ▼ (TLS + API Key/JWT)
┌─────────────────────────────────────────────────────────────────┐
│                    FastMCP Server + Middleware                   │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐     │
│  │ Auth Middleware│→ │ Rate Limiter   │→ │  Audit Logger  │     │
│  │ (API Key/mTLS) │  │ (Semaphore)    │  │  (request_id)  │     │
│  └────────────────┘  └────────────────┘  └────────────────┘     │
└─────────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Query Orchestrator [Enhanced]                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │
│  │ SQL Generator│→ │ SQL Validator│→ │ SQL Executor │           │
│  │  + LLM CB    │  │ + LIMIT Force│  │ + Streaming  │           │
│  │  + Fallback  │  │ + PG Parser  │  │ + DB CB      │           │
│  └──────────────┘  └──────────────┘  └──────────────┘           │
│                                                                  │
│  Result Validator [Optional/Self-hosted]:                        │
│  - Data masking (sensitive columns)                              │
│  - Local model / Rule-based validation                           │
│  - Opt-in external LLM with audit                                │
└─────────────────────────────────────────────────────────────────┘
                             │
              ┌──────────────┼──────────────┐
              ▼              ▼              ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│ Schema Cache     │ │ Metrics Exporter │ │ Audit Log Store  │
│ + Auto Refresh   │ │ (Prometheus)     │ │ (DB/File)        │
│ + Persistence    │ │ + OTEL Traces    │ │                  │
└──────────────────┘ └──────────────────┘ └──────────────────┘
              │
              ▼
┌──────────────────┐
│ PostgreSQL       │
│ + RLS            │
│ + Readonly Role  │
└──────────────────┘
```

---

## 总结

该设计文档展现了**扎实的技术基础**和**清晰的设计思路**，但在**生产就绪性**方面存在差距。主要问题集中在：

1. **安全性**: 缺少多层防御的关键环节（认证、授权、数据脱敏）
2. **可靠性**: 弹性机制定义但未实施
3. **可观测性**: 监控和追踪框架不完整
4. **运维成熟度**: 缺少部署、灾备、多租户等企业级考量

建议根据实际需求和时间约束，选择性地实施上述改进。对于 MVP 版本，可以先聚焦于核心功能，后续迭代再增强安全性和可观测性。
